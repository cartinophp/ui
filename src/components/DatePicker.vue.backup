<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import type { ComponentPublicInstance } from 'vue'
import {
  DateFieldRoot,
  DateFieldInput,
  type DateFieldRootProps,
  type DateFieldRootEmits
} from 'reka-ui'
import { reactiveOmit } from '@vueuse/core'
import theme from '@/themes/date-picker'
import Icon from './Icon.vue'

export interface DatePickerProps
  extends Omit<
    DateFieldRootProps,
    'as' | 'asChild' | 'modelValue' | 'defaultValue'
  > {
  modelValue?: DateFieldRootProps['modelValue']
  defaultValue?: DateFieldRootProps['defaultValue']
  size?: 'xs' | 'sm' | 'md' | 'lg' | 'xl'
  variant?: 'outline' | 'filled' | 'ghost' | 'soft' | 'none'
  color?: 'primary' | 'error' | 'success' | 'warning' | 'info'
  leadingIcon?: string
  trailingIcon?: string
  leading?: boolean
  trailing?: boolean
  loading?: boolean
  autofocus?: boolean
  autofocusDelay?: number
  class?: any
  ui?: Record<string, any>
}

export interface DatePickerEmits
  extends Omit<DateFieldRootEmits, 'update:modelValue'> {
  'update:modelValue': [date: DateFieldRootProps['modelValue']]
  change: [event: Event]
  blur: [event: FocusEvent]
  focus: [event: FocusEvent]
}

const props = withDefaults(defineProps<DatePickerProps>(), {
  size: 'md',
  variant: 'outline',
  color: 'primary',
  trailingIcon: 'solar:calendar-linear',
  autofocusDelay: 0
})

const emit = defineEmits<DatePickerEmits>()

const rootProps = computed(() =>
  reactiveOmit(
    props,
    'modelValue',
    'defaultValue',
    'size',
    'variant',
    'color',
    'leadingIcon',
    'trailingIcon',
    'leading',
    'trailing',
    'loading',
    'autofocus',
    'autofocusDelay',
    'class',
    'ui'
  )
)

const datePickerTheme = computed(() =>
  theme({
    size: props.size,
    variant: props.variant,
    color: props.color,
    disabled: props.disabled,
    leading: props.leading || !!props.leadingIcon,
    trailing: props.trailing || !!props.trailingIcon || props.loading
  })
)

const inputsRef = ref<ComponentPublicInstance[]>([])

function onUpdate(value: any) {
  emit('update:modelValue', value)
  // @ts-ignore
  const event = new Event('change', { target: { value } })
  emit('change', event)
}

function onBlur(event: FocusEvent) {
  emit('blur', event)
}

function onFocus(event: FocusEvent) {
  emit('focus', event)
}

function autoFocus() {
  if (props.autofocus) {
    inputsRef.value[0]?.$el?.focus()
  }
}

onMounted(() => {
  setTimeout(() => {
    autoFocus()
  }, props.autofocusDelay)
})

defineExpose({
  inputsRef
})
</script>

<template>
  <DateFieldRoot
    v-bind="rootProps"
    v-slot="{ segments }"
    :model-value="modelValue"
    :default-value="defaultValue"
    :disabled="disabled"
    :class="datePickerTheme.base({ class: [ui?.base, props.class] })"
    @update:model-value="onUpdate"
    @blur="onBlur"
    @focus="onFocus"
  >
    <span
      v-if="props.leading || props.leadingIcon"
      :class="datePickerTheme.leading({ class: ui?.leading })"
    >
      <Icon
        v-if="leadingIcon"
        :name="leadingIcon"
        :class="datePickerTheme.leadingIcon({ class: ui?.leadingIcon })"
      />
    </span>

    <DateFieldInput
      v-for="(segment, index) in segments"
      :key="`${segment.part}-${index}`"
      :ref="(el) => (inputsRef[index] = el as ComponentPublicInstance)"
      :part="segment.part"
      :class="datePickerTheme.segment({ class: ui?.segment })"
      :data-segment="segment.part"
    >
      {{ segment.value.trim() }}
    </DateFieldInput>

    <span
      v-if="props.trailing || props.trailingIcon || props.loading"
      :class="datePickerTheme.trailing({ class: ui?.trailing })"
    >
      <Icon
        v-if="props.loading"
        name="solar:loading-linear"
        :class="[
          datePickerTheme.trailingIcon({ class: ui?.trailingIcon }),
          'animate-spin'
        ]"
      />
      <Icon
        v-else-if="trailingIcon"
        :name="trailingIcon"
        :class="datePickerTheme.trailingIcon({ class: ui?.trailingIcon })"
      />
    </span>
  </DateFieldRoot>
</template>
